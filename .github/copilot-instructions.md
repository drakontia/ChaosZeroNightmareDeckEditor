# ChaosZeroNightmare Deck Builder — Copilot Coding Agent Instructions

## このドキュメントについて

ｰ この文書は GitHub Copilot Coding Agent が本リポジトリで安全かつ正確に開発タスクを実施するための実務ガイドです。
- 現行コードベース（Next.js 16 / TypeScript / Tailwind v4 / next-intl）に沿った運用ルールを補足しています。
- 新しい機能を実装する際はここで示す技術選定・設計方針・モジュール構成を前提にしてください。
- 不確かな点がある場合は、リポジトリのファイルを探索し、ユーザーに「こういうことですか?」と確認をするようにしてください。

## 前提条件

- 回答は必ず日本語でしてください。
- コードの変更をする際、変更量が200行を超える可能性が高い場合は、事前に「この指示では変更量が200行を超える可能性がありますが、実行しますか?」とユーザーに確認をとるようにしてください。
- 何か大きい変更を加える場合、まず何をするのか計画を立てた上で、ユーザーに「このような計画で進めようと思います。」と提案してください。この時、ユーザーから計画の修正を求められた場合は計画を修正して、再提案をしてください。

## 目的 / スコープ
- ゲーム「カオスゼロナイトメア」のデッキ編集 Web アプリの機能追加・改善・バグ修正。
- ゲーム内のセーブデータの様式を模して、ユーザーが馴染んでいるUI/UXを提供する。
- 仕様への準拠、型安全、UI/UX一貫性、多言語対応の維持。
- 変更は最小限で、既存挙動・公開 API を壊さない。

## 技術スタックと前提
- Framework: Next.js 16.x（App Router, Turbopack）
- Language: TypeScript 5.9.x
- Styling: Tailwind CSS 4.1.x
- i18n: next-intl（ja/en/zh/ko）
- Tests: Vitest（ユニット）、Playwright（E2E）
- Package manager: pnpm
- **リンター/フォーマッター**: ESLint + Prettier
- **型チェック**: TypeScript strict mode

## 主要ドメイン仕様（要点）
- カード種別: `CHARACTER` / `SHARED` / `MONSTER` / `FORBIDDEN`
- カテゴリ: `ATTACK` / `UPGRADE` / `SKILL`
- 基本カードは、潜在力の発現により、効果が変更される。
- エゴ発現の段階により、カード効果が変化することがある。
- ヒラメキ（カード別のバリエーション）
  - キャラカード: 基本 + Lv1〜Lv5（計6段階）
  - その他: 基本のみ。ただし、隠しヒラメキは適用される。
  - レベルに応じてコスト/説明/ステータスが変化
- 神ヒラメキ（5神: `kilken/seclaid/dialos/nihilum/vitol`）
  - ヒラメキ対応カードに追加効果を付与（基本カードは対象外）
  - 効果ごとにコスト修正を持つ場合あり
  - 効果は統一構造で定義され、gods配列で適用可能な神を指定
  - 今後、神が追加される可能性もあり
- 曖昧な記憶（Faint Memory）ポイント算出
  - 種別: Shared(+20pt), Monster(+80pt), Forbidden(+20pt)
  - ヒラメキ: Sharedのみ Lv1以上で +10pt（キャラ・モンスターは0pt）
    - **重要**: モンスターカードはヒラメキポイント（+10pt）が加算されない仕様（現行仕様、将来的に修正される可能性あり）
  - 神ヒラメキ: 全カード +20pt（基本カード除く）
  - 削除: 回数に応じて 0→10→30→50→70pt（キャラカードは+20pt）
  - コピー: 回数に応じて 0→10→30→50→70pt
  - 変換: 基本 +10pt、元カードの属性ポイントは保持
    - 変換先に一時的な排除カードを用意する。排除カードは、デッキには登録しない。削除されている訳ではないので、曖昧な記憶ポイントには影響しない。
  - スナップショット方式で削除/コピー/変換時の属性を記録
- 装備種別: `WEAPON` / `ARMOR` / `PENDANT`
  - 神話級装備は1種のみ選択可能。もし2種類目を選択しようとした場合は、選択画面は閉じずに警告表示のみ行う。

## 曖昧な記憶システム

デッキ編集に基づいてポイントが計算されるシステム。

### ポイント計算ルール

#### デッキ内カード

| 行動 | ポイント | 備考 |
|------|----------|------|
| 共用カードの獲得 | +20pt | キャラカード以外 |
| モンスターカードの獲得 | +80pt | キャラカード以外 |
| 禁忌カード | +20pt | キャラカード以外 |
| 共用カードのヒラメキ（Lv1以上） | +10pt | 共用カードのみ（キャラ・モンスターは0pt） |
| 神ヒラメキ（全カード、基本カード除く） | +20pt | ヒラメキ対応カードのみ |

#### 削除されたカード

| 回数 | ポイント | 備考 |
|------|----------|------|
| 1回目 | 0pt | キャラカードは+20pt追加 |
| 2回目 | +10pt | キャラカードは+20pt追加 |
| 3回目 | +30pt | キャラカードは+20pt追加 |
| 4回目 | +50pt | キャラカードは+20pt追加 |
| 5回目以降 | +70pt | キャラカードは+20pt追加 |

削除時のカード属性（種別・ヒラメキ・神ヒラメキ）は削除時点の状態がスナップショット保存され、加算される。

#### コピーされたカード

| 回数 | ポイント | 備考 |
|------|----------|------|
| 1回目 | 0pt | コピー元の属性（種別・ヒラメキ・神ヒラメキ）を継承 |
| 2回目 | +10pt | - |
| 3回目 | +30pt | - |
| 4回目 | +50pt | - |
| 5回目以降 | +70pt | - |

コピー時のカード属性（種別・ヒラメキ・神ヒラメキ）はコピー時点の状態がスナップショット保存され、加算される。

##### コピーカードのUI表現

コピーされたカードは以下の視覚的特徴で識別可能：
- **カード画像**: 左右反転表示（CSS `transform: scaleX(-1)`）
- **カードステータス**: ステータス欄に「コピー済み」表示

#### 変換されたカード

| 行動 | ポイント | 備考 |
|------|----------|------|
| カードの変換 | +10pt | 基本変換コスト |
| 元カードの属性保持 | 状況次第 | 変換前のヒラメキ・神ヒラメキポイントは保持される |
| 変換先カードの属性 | 状況次第 | 変換後のカードがデッキにある場合、通常通り加算 |

変換時の元カード属性（種別・ヒラメキ・神ヒラメキ）はスナップショット保存される。変換後のカードがデッキから削除されても、元カードと変換の+10ptは残る。

## V2からの変更点
2026年2月6日より適用される主要な変更点は以下の通り：

### 曖昧な記憶のポイント計算の変更

- 固有に獲得できる開始カードとヒラメキカード、合計8枚で構成された基本セーブデータを基準に、
   追加で獲得した要素を中心として価値が計算されます。
- 共用カードはヒラメキの有無とは関係なく、固定された価値として計算されます。
- 神ヒラメキは従来と同じく20ptで計算されます。
- モンスターカードは効果に応じて、一般/希少/伝説グレードに分けられ、
   それぞれの等級は20/50/80ptポイントとして計算されます。
- カードのコピーによるポイントは、従来の0/10/30ptから、0/0/40ptに変更されます。
- 開始カードを除くカードの排除はポイントとして計算されず、排除された開始カードは1枚につき20ptとして計算されます。
   カード変換も排除として計算されます。
- 排除およびコピーには上限が追加されます。
   1つのセーブデータを基準として、コピーは最大4回、排除は最大5回までに制限されます。

### トレサのリワーク

#### シーズン2バランス調整概要
苦痛システムの仕様変更に伴い、トレサのカード全体が調整されます。主な変更点は以下の通り：

- **苦痛システムの変更**: 苦痛が付与者基準で1つのデバフとして重複適用される方式に変更
- **苦痛の最大重複数**: 20重複に制限
- **トレサの戦闘位置付け**: 苦痛を軸とした立ち回りが更に強化される

#### カード調整表

| カード名 | 調整前 | 調整後 | 備考 |
|---------|-------|-------|------|
| **影の短剣** | コスト0/攻撃/【消滅】<br/>ダメージ50%、苦痛2 | コスト0/攻撃/【消滅】<br/>ダメージ80%、苦痛1 | ダメージ強化、苦痛を1に減少 |
| **上級影の短剣** | コスト1/攻撃/【保存/回収】<br/>ダメージ100%、苦痛2×2 | コスト0/攻撃/【保存/消滅】<br/>苦痛2、ダメージ50%、<br/>対象の苦痛数に応じてダメージ量+10% | コスト削減、苦痛数スケーリング効果追加 |
| **短剣抜刀–固有ヒラメキ4** | 影の短剣を2枚生成、<br/>生成された影の短剣の苦痛付与効果が3増加 | 影の短剣を2枚生成、<br/>生成された影の短剣の苦痛付与効果が2増加 | 苦痛付与効果を1減少 |
| **影装填–固有ヒラメキ1** | コスト2/攻撃/【保存】<br/>敵全体にダメージ80%、苦痛2、<br/>手札の影の短剣を全て消滅、その数に応じて繰り返す | コスト1/攻撃/【保存】<br/>敵全体にダメージ80%、苦痛2、<br/>手札の影の短剣を全て消滅、その数に応じて繰り返す | コスト1削減 |
| **影装填–固有ヒラメキ2** | コスト1/スキル/治癒100%、<br/>上級影の短剣2枚生成 | コスト0/スキル/治癒150%、<br/>上級影の短剣1枚生成 | コスト削減、治癒強化、生成数削減 |
| **影装填–固有ヒラメキ3** | コストX/スキル/治癒100%×X、<br/>影の短剣X枚生成 | コストX/スキル/治癒100%×X、<br/>影の短剣、上級影の短剣のうちランダムにX枚生成 | 生成カードがランダムに変更 |
| **影装填–固有ヒラメキ4** | コスト1/強化/【開戦】<br/>スキルカードで治癒時、影の短剣を1枚生成 | コスト1/スキル/<br/>全ての影の短剣消滅、その数に応じて、上級影の短剣を生成 | カテゴリ変更、効果変更（短剣変換機能） |
| **影装填–固有ヒラメキ5** | コスト1/スキル/【消滅】<br/>カードを全て破棄、その数に応じて、影の短剣を生成 | コスト1/スキル/【消滅2】<br/>カードを全て破棄、その数に応じて、影の短剣を生成 | 消滅が【消滅2】に変更 |
| **急所攻撃–固有ヒラメキ3** | コスト2/攻撃/ダメージ80%×3、<br/>1ターンの間、苦痛ダメージ量+50% | コスト1/攻撃/ダメージ80%×3、<br/>苦痛2～6 | コスト削減、効果をダイスロール形式に変更 |
| **呪い切り落とし** | コスト1/スキル/<br/>苦痛刻印2、弱体化2 | コスト1/スキル/<br/>対象が保有中の自分の苦痛発動 | 効果完全変更（苦痛消費スキル） |

#### 調整の背景
苦痛システムの動作方式が「付与者基準で1つのデバフとして重複適用」に変更されたことで、トレサの苦痛管理戦略がより直感的になります。従来の複数デバフ方式から単一デバフ方式へ移行することで、以下の改善が実現：

- 苦痛の重複数に応じたダメージ期待値がより明確化
- トレサのカード効果が苦痛数に依存する設計により、シナジーが強化
- 影の短剣のコスト効率改善により、序盤～中盤の展開力向上
- 上級影の短剣がコスト0になることで、苦痛スケーリングの活用機会拡大

### カシウスのリワーク

#### クエスト動作方式の変更
カシウスのクエスト動作方式が修正されます。クエスト達成時に治癒効果が追加され、パーティーの維持力が強化されます。また、1ターンに達成可能なクエスト回数は3回に制限されます。

#### クエストカード変更

| カード名 | 調整前 | 調整後 | 備考 |
|---------|-------|-------|------|
| **クエスト動作方式変更** | 戦闘中に達成条件を満たすと、<br/>報酬のクエストカードを生成、<br/>ただし、クエストカードは達成条件に含まない | 戦闘中に達成条件を満たすと、<br/>報酬のクエストカードを生成、<br/>固定治癒80%(各ターン3回)<br/>ただし、クエストカードは達成条件に含まない | 治癒効果追加<br/>達成回数制限（3回/ターン） |

#### スリーカード調整

| カード名 | 調整前 | 調整後 | 備考 |
|---------|-------|-------|------|
| **「0」のスリーカード** | コスト0/攻撃/【消滅/蒸発】<br/>今回のターンで使用した攻撃カードの数に応じて、<br/>ダメージ40% | コスト0/攻撃/【消滅/蒸発】<br/>ダメージ40%、今回のターンで使用した攻撃カードの数に応じて、<br/>ダメージ量+40%(最大4回) | ダメージ計算方式を明確化 |
| **強化された「0」のスリーカード** | コスト0/攻撃/【消滅/蒸発】<br/>今回のターンで使用した攻撃カードの数に応じて、<br/>ダメージ50% | コスト0/攻撃/【消滅/蒸発】<br/>ダメージ50%、今回のターンで使用した攻撃カードの数に応じて、<br/>ダメージ量+50%(最大4回) | ダメージ計算方式を明確化 |
| **「1」のスリーカード** | コスト0/攻撃/<br/>【消滅/蒸発】ダメージ90%、治癒90% | コスト0/攻撃/<br/>【消滅/蒸発】ダメージ150%、治癒150% | ダメージ・治癒強化 |
| **強化された「1」のスリーカード** | コスト0/攻撃/<br/>【消滅/蒸発】ダメージ120%、治癒120% | コスト0/攻撃/<br/>【消滅/蒸発】ダメージ200%、治癒200% | ダメージ・治癒大幅強化 |
| **フルハウス** | コスト0/スキル/【消滅/蒸発】ドロー1 | コスト0/スキル/【消滅/蒸発】<br/>ドロー1、ランダムな味方のストレス2減少 | ストレス軽減効果追加 |
| **強化されたフルハウス** | コスト0/スキル/【消滅/保存】ドロー1 | コスト0/スキル/【消滅/保存】<br/>ドロー1、ランダムな味方のストレス3減少 | ストレス軽減効果追加 |

#### ダイストリック調整

| カード名 | 調整前 | 調整後 | 備考 |
|---------|-------|-------|------|
| **ダイストリック** | コスト2/攻撃/ダメージ240%、<br/>完了したクエストの回数に応じてコスト減少 | コスト2/攻撃/ダメージ240%、<br/>1ターンの間、士気1減少、<br/>完了したクエストの回数に応じてコスト減少 | 士気デバフ追加 |
| **ダイストリック–固有ヒラメキ1** | コスト2/攻撃/ダメージ360%、<br/>完了したクエストの回数に応じてコスト減少 | コスト2/攻撃/ダメージ360%、<br/>1ターンの間、士気1減少、<br/>完了したクエストの回数に応じてコスト減少 | 士気デバフ追加 |
| **ダイストリック–固有ヒラメキ2** | コスト2/攻撃/敵全体にダメージ300%、<br/>完了したクエストの回数に応じてコスト減少 | コスト2/攻撃/敵全体にダメージ300%、<br/>1ターンの間、士気1減少、<br/>完了したクエストの回数に応じてコスト減少 | 士気デバフ追加 |
| **ダイストリック–固有ヒラメキ3** | コスト0/攻撃/ダメージ80%、<br/>完了したクエストの回数に応じてダメージ量+80% | コスト0/攻撃/ダメージ80%、<br/>完了したクエストの回数に応じてダメージ量+80%(最大5回) | 上限設定 |
| **ダイストリック–固有ヒラメキ4** | コスト2/強化/<br/>クエストカード使用時、治癒100%、<br/>ランダムな敵に固定ダメージ100% | コスト2/強化/【唯一】<br/>クエストカード使用時、治癒100%、<br/>ランダムな敵に固定ダメージ100% | 【唯一】効果追加 |
| **ダイストリック–固有ヒラメキ5** | コスト2/強化/クエスト完了時、<br/>クエストカードを1枚生成 | コスト2/強化/【唯一】ターン開始時、<br/>強化されたクエストカードを1枚生成 | 【唯一】効果追加、発動タイミング変更 |

#### 調整の背景
カシウスのクエスト動作方式が修正されます。クエスト達成時に治癒効果が追加され、パーティーの維持力が強化されます。また、1ターンに達成可能なクエスト回数は3回に制限されます。これにより、4種類のクエストを達成していくカシウスの魅力的な核心的戦闘体験はできるだけ維持しつつ、達成難易度の低い特定のクエストが戦闘員の運用全体に過度な影響を与える状況を改善します。

### 一部の装備および共用カードの調整

カオスで登場する一部の装備と共用カードが調整されます。

#### 装備の調整

| 調整対象 | 調整前 | 調整後 | 備考 |
|---------|-------|-------|------|
| **脳波遮断ヘルメット** | 能力でドロー時、固定シールド40% | 能力でドロー時、固定シールド40%(各ターン5回) | 発動回数上限設定 |
| **サイオニック戦闘強化服** | カード消滅時、固定シールド30% | カード消滅時、固定シールド30%(各ターン5回) | 発動回数上限設定 |

#### 共用カードの調整

| 調整対象 | 調整前 | 調整後 | 備考 |
|---------|-------|-------|------|
| **空虚の放浪者** | コスト0/スキル/1ターンの間、<br/>対象の行動カウントが減少しない | コスト0/スキル/【消滅】1ターンの間、<br/>対象の行動カウントが減少しない | 【消滅】効果追加 |
| **戦術対応** | コスト1/強化/【開戦】<br/>シールド所持中の対象に、ダメージ量15%増加 | コスト1/強化/【開戦】<br/>シールド所持中の対象に、ダメージ量25%増加(最大1) | ダメージ増加効果上方修正、上限設定 |
| **酸性ガス** | コスト1/スキル/【回収】敵全体に損傷2 | コスト0/スキル/【回収/消滅】敵全体に損傷3 | コスト削減、【消滅】追加、損傷強化 |
| **集結** | コスト0/スキル/【迅速】ドロー1、<br/>敵全体の行動カウントが3増加 | コスト0/スキル/【迅速/消滅2】ドロー1、<br/>敵全体の行動カウントが3増加 | 【消滅2】追加 |

#### 調整の背景
これらの装備は、ドローや消滅を多く発生させる戦闘員と組み合わせた場合、装備のグレードに対して企画意図よりも高い性能を発揮していることが確認されました。効果数値や発動回数に制限がなかった従来の構造により、多様な選択肢を圧倒する状況が発生していたため、より幅広い戦略選択と多様なプレイ体験をご提供するため、今回の調整が適用されます。

今回の調整により、特定の装備やカードが過度に優勢な戦略として機能する状況を緩和し、より多様な装備や共用カードが活躍できる環境をご提供することを目指します。

#### モンスターカードの再グレード調整

変更されるセーブデータの規定に伴い、モンスターカードの保存ルールが変更されるため、既存のモンスターカードグレードが固有グレードから一般/希少/伝説グレードに再調整されます。各カードの効果は従来と同じです。

##### 攻撃カード

| グレード | 名前 | コスト | カード効果 |
|---------|------|--------|---------|
| 一般 | 恥ずかしがり屋の庭師 | 1 | ダメージ50%×4、標識3 |
| 一般 | 鬱陶しい代父 | 1 | ダメージ50%×4、苦痛6 |
| 一般 | 羽の人面獣 | 1 | ランダムな敵にダメージ50%×5 |
| 一般 | ウルブズ・ヴェイン | 1 | 敵全体にダメージ120%、弱体化2、損傷2 |
| 一般 | 闇の掌中 | 1 | ダメージ120%×2、撃破：ランダムな敵にダメージ120%×2 |
| 一般 | ロットンリッパー | 1 | 【迅速】ダメージ160%、行動カウント1増加 |
| 一般 | 苦痛の熾天使 | 2 | ダメージ250%、手札にこのカードだけがある場合、コスト2減少 |
| 一般 | ビームシューター | 3 | ダメージ350%、対象がシールド所持中の場合、ダメージ量+50% |
| 希少 | オートマタカヴァリ | 1 | ダメージ150%、脆弱4 |
| 希少 | ソルジャープライム | 2 | ダメージ300%、大破時、アクションポイント2獲得 |
| 伝説 | セブンアームズ | 1 | 【迅速】ダメージ120%、対象の行動カウントが5以上の場合、アクションポイント2獲得 |

##### スキルカード

| グレード | 名前 | コスト | カード効果 |
|---------|------|--------|---------|
| 一般 | 奈落の虫 | 0 | 【消滅】士気1減少、決意3減少 |
| 一般 | 冷ややかな代父 | 0 | 山札のカードを、下から1枚発動、手札のカード1枚選択、そのカードを山札の一番下に移動 |
| 一般 | トラッパー | 1 | シールド120%、脆弱1、対象が行動しなかった場合、シールド獲得量+120%、脆弱1追加 |
| 一般 | カルティストアービター | 1 | シールド140%、次のターン開始時、敵全体の行動カウント2増加 |
| 一般 | スローター | 2 | 【消滅】シールド200%、獲得したシールドに応じて、敵全体にダメージ |
| 希少 | 空虚な飢え | 0 | 【消滅】士気吸収2 |
| 希少 | 悪霊サラマンダー | 1 | 【消滅2】ドロー4 |
| 希少 | 消失の飢え | 1 | 【消滅】ドロー1、手札のカードがない場合、ドロー4追加 |
| 希少 | 精霊フェニックス | 1 | 【消滅】決意2、減少したHPに応じて、シールド獲得 |
| 希少 | 精霊キャフォックス | 1 | 【消滅】山札から1枚を選択しドロー、そのカードに回収付与 |

##### 強化カード

| グレード | 名前 | コスト | カード効果 |
|---------|------|--------|---------|
| 希少 | アルビトゥム | 0 | 受けるダメージ量-15%(各ターン1回) |
| 希少 | 陰気な代母 | 1 | ターン終了時、ランダムな敵にダメージ200% |
| 希少 | 甲殻虫 | 1 | クリスタライズ5 |
| 伝説 | 悪霊デュラハン | 1 | ターゲティング攻撃カード使用時、対象に苦痛1 |
| 伝説 | ドミニオン | 2 | ターン開始時、士気1 |

##### 精霊キャフォックスの個別調整

| 調整対象 | 調整前 | 調整後 |
|---------|-------|-------|
| **精霊キャフォックス** | 【消滅】山札から1枚を選択しドロー、そのカード1枚を手札にコピー | 【消滅】山札から1枚を選択しドロー、そのカードに回収付与 |

## データ構造（実装の基準）
型は `types/index.ts` に準拠します。特に以下に注意：
- `DeckCard`: `deckId`, `selectedHiramekiLevel`, `godHiramekiType`, `godHiramekiEffectId` 等を保持
- `Deck`: `removedCards: Map<string, number | RemovedCardEntry>`, `copiedCards: Map<string, number | CopiedCardEntry>`, `convertedCards: Map<string, string | ConvertedCardEntry>`
- 変換管理: `convertedCards` は Map で originalId → (convertedId | ConvertedCardEntry) を保存
- スナップショット型: `RemovedCardEntry`, `CopiedCardEntry`, `ConvertedCardEntry` で削除/コピー/変換時の属性を記録
- 神ヒラメキ: `GodHiramekiDefinition` は統一構造で、`gods` 配列で適用可能な神を指定

## ファイル構成（主要）
- `app/` … Next.js App Router
- `components/` … UI/ロジックコンポーネント（`DeckBuilder.tsx`, `DeckDisplay.tsx`, `CardSelector.tsx` 等）
- `hooks/` … 状態管理（`useDeckBuilder.ts`）
- `lib/` … ドメインデータ/ユーティリティ
- `messages/` … 多言語 JSON（ja/en/zh/ko）
- `tests/` … Playwright/Vitest テスト
- `types/` … 型定義
- `scripts/` … データ入力支援スクリプト

## アーキテクチャ指針

### コンポーネント設計

- **Atomic Design の部分的採用**: `/components/ui` に基本コンポーネント、`/components` 内に機能特化コンポーネント
- **Composition Pattern**: 小さなコンポーネントを組み合わせて複雑な UI を構築
- **Container/Presentational Pattern**: ロジックと表示を分離 (hooks でロジックを抽出)

### 状態管理の方針

- **ローカル状態**: `useState` / `useReducer` で管理
- **グローバル状態**: Zustand で管理

## ディレクトリ・ファイル命名規則

### コンポーネント

- **ファイル名**: PascalCase (例: `TaskList.tsx`, `TaskCard.tsx`)
- **ディレクトリ**: ケバブケース (例: `task-list/`, `calendar-view/`)
- **index.ts**: 各ディレクトリに配置し、外部へのエクスポートを集約

### フック

- **ファイル名**: camelCase + `use` プレフィックス (例: `useTaskList.ts`, `useAuth.ts`)

### ユーティリティ

- **ファイル名**: camelCase (例: `formatDate.ts`, `validateEmail.ts`)

### 型定義

- **ファイル名**: camelCase または PascalCase (例: `task.types.ts`, `Task.ts`)
- **型名**: PascalCase (例: `Task`, `User`, `ApiResponse<T>`)

## UI 実装ガイド

### コンポーネント設計原則

- **Single Responsibility**: 1つのコンポーネントは1つの責務のみ
- **Props の型定義**: 全ての props に明示的な型を定義
- **デフォルトエクスポートを避ける**: Named export を使用し、リファクタリングを容易に
- **children パターン**: 柔軟性が必要な場合は `children` を活用

### スタイリング

- **Tailwind CSS をベースに使用**: ユーティリティファーストのアプローチ
- **共通スタイルの定義**: `styles/globals.css` でカスタムユーティリティクラスを定義
- **CSS Modules**: コンポーネント固有の複雑なスタイルが必要な場合のみ使用
- **レスポンシブ対応**: Tailwind のブレークポイント (`sm:`, `md:`, `lg:`) を活用

### アクセシビリティ (a11y)

- **セマンティック HTML**: 適切な HTML タグを使用 (`<button>`, `<nav>`, `<main>` 等)
- **aria 属性**: 必要に応じて `aria-label`, `aria-describedby` 等を付与
- **キーボード操作**: すべての操作をキーボードで実行可能に
- **フォーカス管理**: `focus-visible` で適切なフォーカススタイルを適用

### パフォーマンス最適化

- **React.memo**: 不要な再レンダリングを防ぐ
- **useMemo / useCallback**: 高コストな計算や関数の再生成を防ぐ
- **Code Splitting**: React.lazy + Suspense で遅延ロード
- **画像最適化**: WebP 形式、適切なサイズ、lazy loading

## テスト戦略

### 単体テスト (Vitest)

- **hooks**: `@testing-library/react-hooks` でテスト
- **utils**: 純粋関数のロジックをテスト
- **stores**: Zustand ストアのアクションと状態変化をテスト

### コンポーネントテスト (React Testing Library)

- **ユーザーインタラクション**: `fireEvent` / `userEvent` でイベントをシミュレート
- **非同期処理**: `waitFor` で非同期レンダリングを待機

### E2E テスト (Playwright / Cypress)

- **主要フロー**: キャラクター選択 → カード追加 → ヒラメキ編集 → 共有のフローをテスト
- **クロスブラウザ**: Chrome でテスト

## 開発・テスト手順
- 依存関係の導入・開発起動
  ```bash
  pnpm install
  pnpm dev
  ```
- ユニットテスト（必須）
  ```bash
  pnpm test            # Vitest 実行
  pnpm test:ui         # Vitest UI（必要時）
  ```
- E2E（必要に応じて変更影響が UI に及ぶ場合に）
  ```bash
  pnpm test:playwright # Playwright 実行
  ```
- ビルド/起動確認（PR前の最終確認）
  ```bash
  pnpm build
  pnpm start
  ```

## 実装ルール
- 型安全: すべて TypeScript で厳密に型定義を尊重（`types/index.ts` を参照）。
- i18n: 表示文言は next-intl のキーを用い、`messages/*` にキー追加。既存キー構造に従い、フォールバックを適切に設定。
- UI: Tailwind v4 記法に準拠。Shadcn UI コンポーネントのスタイル/アクセシビリティを維持。
- 最小変更: 既存 API/挙動を壊さず、差分を限定的に。
- 仕様準拠: `SPECIFICATION.md` に沿い、現行コードとの差異はコード側を優先（例: `convertedCards` は Map）。
- ドメイン整合性: ヒラメキ/神ヒラメキのルール、ポイント算出のルールを守る。

## 変更の作法（PR作成の指針）
- ブランチ: `feature/<短く要点>` / `fix/<短く要点>` など意味のある名前。
- コミット: 1つの目的に絞った小さなコミット。メッセージは動詞先行で簡潔に。
- PR説明: 目的/背景、仕様への整合性、UI変更のスクリーンショット（必要時）、テスト実行結果の要約。
- テスト: 変更に関係するユニットテストを追加/更新。UIに影響がある場合は E2E 更新も検討。
- i18n: 新規文言は全言語にキー追加。未翻訳は一時的にフォールバック（英語 or 日本語）。

## コーディング規約・ベストプラクティス

### TypeScript の作法

- **strict モード**: `tsconfig.json` で `strict: true`
- **any の禁止**: `no-explicit-any` ルールを有効化
- **型推論の活用**: 冗長な型注釈は避け、推論に任せる
- **ユニオン型**: 状態を明示的に表現 (例: `type Status = 'idle' | 'loading' | 'success' | 'error'`)

### React の作法

- **関数コンポーネント**: クラスコンポーネントは使用しない
- **hooks のルール**: トップレベルでのみ呼び出し、条件分岐内で呼び出さない
- **useEffect の依存配列**: 正確に指定し、不要な再実行を防ぐ
- **key prop**: リストレンダリング時に一意で安定した key を使用

### 非同期処理

- **async/await**: Promise チェーンよりも優先
- **エラーハンドリング**: try-catch で必ずエラーをキャッチ
- **AbortController**: 不要なリクエストはキャンセル

### インポート順序

1. React 関連
2. 外部ライブラリ
3. 内部モジュール (features, shared, lib)
4. 型定義
5. スタイル

```typescript
import { useState, useEffect } from 'react';
import { useQuery } from '@tanstack/react-query';

import { TaskList } from '@/features/task/components';
import { Button } from '@/components/ui';
import { formatDate } from '@/utils';

import type { Task } from '@/features/task/types';

import styles from './Home.module.css';
```

### コメント

- **JSDoc**: 複雑な関数には JSDoc コメントを付与
- **TODO コメント**: 一時的な実装には `// TODO:` を残す
- **コメントアウト**: 不要なコードは削除し、コメントアウトは残さない

## よくある実装ポイント
- カード検索: 翻訳済み名称/説明/カテゴリに対して大小文字無視の部分一致でフィルタ。
- 変換モーダル: 共用/禁忌カードのみ選択可能。変換はデッキ内で1枚置換し、`convertedCards` に original→converted を記録。復元時は変換先をデッキから除外。
  - Zustand/ローカルストアともにdeckId指定で元カードを変換先カードで置換し、convertedCardsにConvertedCardEntryスナップショットを記録すること
  - 復元時は変換先をデッキから除外し、元カードを復元すること
- ヒラメキ UI: レベル選択（キャラ最大6段階、その他最大4段階）。説明・コスト・カテゴリー・ステータスを連動更新。
  - 隠しヒラメキ：　隠しヒラメキは全てのカードで共通している。そのため、ヒラメキの選択画面で表示されているカードの下に隠しヒラメキのボタンを表示する。ボタンをクリックすると、隠しひらめきの説明とコスト、カテゴリー、ステータスが反映されたカードが並んで表示され、選択できるようにする。
- 神ヒラメキ: 2段階選択（神→効果）。効果に応じたコスト修正を反映。神ヒラメキの効果を説明の下に追加で表示する。
- 曖昧な記憶: `lib/deck-utils.ts` のルールに従い、行動ごとの加点を正しく計算。

## 破壊的変更の禁止例
- 型定義の互換性を壊す変更（引数/戻り値の型を勝手に変更）
- i18nキー構造の破壊（既存キーの削除・意味変更）
- 既存コンポーネントの公開プロップの後方互換性を損なう変更

## セキュリティ / 品質
- XSS/CSRF 等は Next.js/React 標準挙動に準拠しつつ、危険な HTML を挿入しない。
- コード整形は既存のスタイルに合わせる。不要なリファクタリングは避ける。
- 大規模改修は要分割・段階的 PR。

## 失敗時の対応
- ビルド/テスト失敗時は差分を見直し、最小修正で復旧。
- i18nエラー（キー欠落等）はフォールバックを暫定使用し、キーを追って追加。

## アンチパターン

以下のパターンは避けてください。既存コードで発見した場合は、リファクタリングを提案してください。

### コンポーネント設計

- **巨大コンポーネント**: 1つのコンポーネントが200行を超える場合は分割を検討
- **Prop Drilling**: 深い階層での props バケツリレーは、Context や状態管理ライブラリで解決
- **useEffect の濫用**: データフェッチは React Query、イベントハンドラーで済む処理は useEffect を使わない

### 状態管理

- **過度なグローバル状態**: 真にグローバルな状態のみを Zustand で管理
- **useState の濫用**: 複雑な状態は useReducer で管理
- **直接的な状態変更**: イミュータブルな更新を心がける

### パフォーマンス

- **不要な再レンダリング**: React DevTools Profiler で計測し、必要に応じて最適化
- **過度な最適化**: 実測せずに useMemo/useCallback を多用しない
- **巨大なバンドル**: Code Splitting を活用し、初期ロードを軽量化

### TypeScript

- **any の濫用**: 型推論が難しい場合は `unknown` を使用し、型ガードで絞り込む
- **型アサーション (as)**: 必要最小限に留め、型の安全性を保つ
- **オプショナルの濫用**: 本当に必要な場合のみ `?` を使用

## セキュリティとプライバシー

- **環境変数**: API キーは `.env` で管理し、`.gitignore` に追加
- **XSS 対策**: ユーザー入力は適切にサニタイズ、React の JSX は自動エスケープ
- **CSRF 対策**: Firebase Authentication のトークンベース認証で対応
- **HTTPS 通信**: 本番環境では必ず HTTPS を使用
- **CSP (Content Security Policy)**: 適切な CSP ヘッダーを設定

## アクセシビリティ (a11y) ガイドライン

- **WCAG 2.1 AA レベル**: 準拠を目指す
- **スクリーンリーダー対応**: ARIA 属性を適切に使用
- **キーボードナビゲーション**: Tab, Enter, Escape キーでの操作をサポート
- **カラーコントラスト**: 4.5:1 以上のコントラスト比を維持
- **axe DevTools**: 開発時に定期的にチェック

## 国際化 (i18n)

- **next-intl**: 多言語対応
- **言語ファイル**: `messages/{lang}.json`
- **日付・数値フォーマット**: `Intl` API を活用

## まとめ

このドキュメントを常に最新に保ち、新しい技術選定や設計変更があった場合は適宜更新してください。GitHub Copilot や AI ツールは、このドキュメントを参照することで、プロジェクトのコンテキストを正確に理解し、より適切なコード提案を行うことができます。

## 参考
- 仕様: `SPECIFICATION.md`
- 型/ロジック: `types/index.ts`, `hooks/useDeckBuilder.ts`, `lib/*`
- UI: `components/*`
- テスト: `tests/*`

本ガイドに従い、変更は必ずテスト・ビルドで裏付けてから PR を作成してください。
